---
- name: Install system utilities
  hosts: localhost
  connection: local
  become: true
  vars:
    system_arch: "{{ ansible_architecture }}"

  tasks:
    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install Git (from OS repo)
      ansible.builtin.apt:
        name: git
        state: present

    - name: Install ripgrep (from OS repo)
      ansible.builtin.apt:
        name: ripgrep
        state: present

    - name: Install fd-find (from OS repo) - provides fdfind command
      ansible.builtin.apt:
        name: fd-find
        state: present

    - name: Install procs (from OS repo)
      ansible.builtin.apt:
        name: procs
        state: present

    - name: Install glances (from OS repo)
      ansible.builtin.apt:
        name: glances
        state: present

    - name: Install lsd (from OS repo)
      ansible.builtin.apt:
        name: lsd
        state: present

    - name: Create symlink fd -> fdfind (if fd-find installed)
      ansible.builtin.file:
        src: /usr/bin/fdfind
        dest: /usr/local/bin/fd
        state: link
        force: true
      when: "'fd-find' in ansible_facts.packages"

    - name: Check if witr is available in Debian repos
      ansible.builtin.command: apt-cache search ^witr$
      register: witr_search
      ignore_errors: true
      changed_when: false

    - name: Check if witr is available in Debian repos
      ansible.builtin.command: apt-cache search ^witr$
      register: witr_search
      ignore_errors: true
      changed_when: false

    - name: Install witr from GitHub using official install script
      when: witr_search.stdout_lines | length == 0
      block:
        - name: Download witr install script
          ansible.builtin.get_url:
            url: https://raw.githubusercontent.com/pranshuparmar/witr/main/install.sh
            dest: /tmp/install-witr.sh
            mode: '0755'
            force: true

        - name: Execute witr install script
          ansible.builtin.command: /tmp/install-witr.sh
          register: witr_install
          changed_when: "'already installed' not in witr_install.stdout"

        - name: Clean up install script
          ansible.builtin.file:
            path: /tmp/install-witr.sh
            state: absent

        - name: Verify witr installation
          ansible.builtin.command: which witr
          register: witr_path
          changed_when: false

        - name: Display installation result
          ansible.builtin.debug:
            msg: "witr installed at: {{ witr_path.stdout }}"
          when: witr_path.stdout != ""

    - name: Verify installations
      ansible.builtin.command: "{{ item }} --version"
      register: version_checks
      ignore_errors: true
      changed_when: false
      loop:
        - git
        - rg
        - fdfind
        - procs
        - glances
        - lsd
        - witr

    - name: Display installation results
      ansible.builtin.debug:
        msg: |
          Установка завершена:
          Git: {{ '✓' if 'git version' in version_checks.results[0].stdout else '✗' }}
          ripgrep: {{ '✓' if 'ripgrep' in version_checks.results[1].stdout else '✗' }}
          fd: {{ '✓' if 'fd' in version_checks.results[2].stdout or 'fdfind' in version_checks.results[2].stdout else '✗' }}
          procs: {{ '✓' if 'procs' in version_checks.results[3].stdout else '✗' }}
          glances: {{ '✓' if 'glances' in version_checks.results[4].stdout else '✗' }}
          lsd: {{ '✓' if 'lsd' in version_checks.results[5].stdout else '✗' }}
          witr: {{ '✓' if version_checks.results[6].rc == 0 else '✗' }}
